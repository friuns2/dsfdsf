name: Reusable Build Android APK

on:
  workflow_call:
    inputs:
      node-version:
        description: Node.js version to install
        required: false
        default: '18'
        type: string
      java-version:
        description: Java version for the Android build
        required: false
        default: '17'
        type: string
      npm-install-command:
        description: Command to install dependencies
        required: false
        default: npm ci
        type: string
      web-build-command:
        description: Command that builds the web assets
        required: false
        default: npm run build
        type: string
      web-dir:
        description: Directory containing the built web assets
        required: false
        default: dist
        type: string
      app-name:
        description: Override for the Capacitor app name
        required: false
        default: ''
        type: string
      app-id:
        description: Override for the Capacitor app id (e.g. com.example.app)
        required: false
        default: ''
        type: string
      server-url:
        description: Override for the Capacitor server url (e.g. https://example.com/)
        required: false
        default: ''
        type: string
      artifact-name:
        description: Name for the uploaded APK artifact
        required: false
        default: ''
        type: string
      artifact-retention-days:
        description: Retention days for the uploaded artifact
        required: false
        default: 30
        type: number
      gradle-task:
        description: Gradle task used to build the APK
        required: false
        default: assembleDebug
        type: string
      create-release:
        description: Publish a GitHub Release with the APK
        required: false
        default: true
        type: boolean
      release-tag-prefix:
        description: Prefix for the release tag (suffix will be the run number)
        required: false
        default: apk
        type: string
      release-name-prefix:
        description: Prefix for the release name (suffix will be the run number)
        required: false
        default: APK Release
        type: string

jobs:
  build-apk:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs['node-version'] }}
          cache: npm

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs['java-version'] }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: ${{ inputs['npm-install-command'] }}

      - name: Build web app
        run: ${{ inputs['web-build-command'] }}

      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli

      - name: Derive metadata
        id: metadata
        run: |
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          REPO_NAME_LOWER=$(echo "$REPO_NAME" | tr '[:upper:]' '[:lower:]')
          ACTOR_LOWER=$(echo "$GITHUB_ACTOR" | tr '[:upper:]' '[:lower:]')

          if [ -n "${{ inputs.app-name }}" ]; then
            APP_NAME="${{ inputs.app-name }}"
          else
            APP_NAME=$(python3 - <<'PY'
import os
name = os.environ["REPO_NAME"].replace("-", " ")
print(" ".join(word.capitalize() for word in name.split()))
PY
)
          fi

          if [ -n "${{ inputs.app-id }}" ]; then
            APP_ID="${{ inputs.app-id }}"
          else
            APP_ID="com.${ACTOR_LOWER}.${REPO_NAME_LOWER}"
          fi

          if [ -n "${{ inputs.server-url }}" ]; then
            SERVER_URL="${{ inputs.server-url }}"
          else
            SERVER_URL="https://${GITHUB_ACTOR}.github.io/${REPO_NAME}/"
          fi

          if [ -n "${{ inputs.artifact-name }}" ]; then
            ARTIFACT_NAME="${{ inputs.artifact-name }}"
          else
            ARTIFACT_NAME="${REPO_NAME}-apk"
          fi

          TAG_PREFIX="${{ inputs['release-tag-prefix'] }}"
          RELEASE_TAG="${TAG_PREFIX}-${GITHUB_RUN_NUMBER}"
          RELEASE_NAME_PREFIX="${{ inputs['release-name-prefix'] }}"
          RELEASE_NAME="${RELEASE_NAME_PREFIX} ${GITHUB_RUN_NUMBER}"

          RELEASE_FILE="${ARTIFACT_NAME}-debug.apk"

          echo "APP_NAME=$APP_NAME" >> "$GITHUB_ENV"
          echo "APP_ID=$APP_ID" >> "$GITHUB_ENV"
          echo "SERVER_URL=$SERVER_URL" >> "$GITHUB_ENV"
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> "$GITHUB_ENV"
          echo "RELEASE_TAG=$RELEASE_TAG" >> "$GITHUB_ENV"
          echo "RELEASE_NAME=$RELEASE_NAME" >> "$GITHUB_ENV"
          echo "RELEASE_FILE=$RELEASE_FILE" >> "$GITHUB_ENV"
          echo "WEB_DIR=${{ inputs['web-dir'] }}" >> "$GITHUB_ENV"
          echo "GRADLE_TASK=${{ inputs['gradle-task'] }}" >> "$GITHUB_ENV"

      - name: Initialize Capacitor
        run: npx cap init "$APP_NAME" "$APP_ID" --web-dir="$WEB_DIR"

      - name: Add Android platform
        run: |
          rm -rf android
          npx cap add android

      - name: Configure Capacitor for GitHub Pages
        run: |
          cat > capacitor.config.json <<EOF
          {
            "appId": "$APP_ID",
            "appName": "$APP_NAME",
            "webDir": "$WEB_DIR",
            "bundledWebRuntime": false,
            "server": {
              "url": "$SERVER_URL",
              "cleartext": true
            }
          }
          EOF

      - name: Copy web assets to Android
        run: npx cap sync android

      - name: Add Android permissions
        run: |
          MANIFEST_FILE="android/app/src/main/AndroidManifest.xml"
          if [ -f "$MANIFEST_FILE" ]; then
            if ! grep -q "android.permission.INTERNET" "$MANIFEST_FILE"; then
              sed -i '/<\/manifest>/i \    <uses-permission android:name="android.permission.INTERNET" />' "$MANIFEST_FILE"
            fi
            if ! grep -q "android.permission.ACCESS_NETWORK_STATE" "$MANIFEST_FILE"; then
              sed -i '/<\/manifest>/i \    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />' "$MANIFEST_FILE"
            fi
          fi

      - name: Build Android APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew "$GRADLE_TASK"

      - name: Prepare Release APK
        run: |
          cp android/app/build/outputs/apk/debug/app-debug.apk "$RELEASE_FILE"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.RELEASE_FILE }}
          retention-days: ${{ inputs['artifact-retention-days'] }}

      - name: Create Release
        if: inputs['create-release'] == true
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          body: |
            Automated APK build for commit ${{ github.sha }}

            **Repository:** ${{ github.repository }}
            **Workflow:** ${{ github.workflow }}
            **Run:** ${{ github.run_number }}
          files: ${{ env.RELEASE_FILE }}
          draft: false
          prerelease: false

