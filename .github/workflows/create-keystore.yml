name: Create and Publish Keystore

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., v1.0.0-keystore)'
        required: true
        default: 'v1.0.0-keystore'
      keystore_alias:
        description: 'Keystore alias'
        required: true
        default: 'android_key'
      key_password:
        description: 'Key password'
        required: true
        default: 'android_key_password'
      store_password:
        description: 'Store password'
        required: true
        default: 'android_store_password'

jobs:
  create-keystore:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Generate keystore
      run: |
        # Create keystore directory if it doesn't exist
        mkdir -p android/keystore

        # Generate keystore using keytool
        keytool -genkeypair \
          -v \
          -keystore android/keystore/release.keystore \
          -storetype PKCS12 \
          -alias ${{ github.event.inputs.keystore_alias }} \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -storepass ${{ github.event.inputs.store_password }} \
          -keypass ${{ github.event.inputs.key_password }} \
          -dname "CN=AI Engineer Simulator, OU=Development, O=AI Engineer, L=City, ST=State, C=US"

        echo "Keystore generated successfully"

    - name: Verify keystore
      run: |
        keytool -list -v -keystore android/keystore/release.keystore -storepass ${{ github.event.inputs.store_password }}

    - name: Create release archive
      run: |
        cd android/keystore
        tar -czf keystore-${{ github.event.inputs.release_tag }}.tar.gz release.keystore
        cd ../..

    - name: Create GitHub release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.event.inputs.release_tag }}
        release_name: Keystore Release ${{ github.event.inputs.release_tag }}
        body: |
          This release contains the Android keystore file for signing the AI Engineer Job Simulator app.

          **Keystore Information:**
          - Alias: `${{ github.event.inputs.keystore_alias }}`
          - Store Password: `${{ github.event.inputs.store_password }}`
          - Key Password: `${{ github.event.inputs.key_password }}`

          **Important Security Notes:**
          - Store these passwords securely
          - Never commit keystore passwords to version control
          - Use GitHub Secrets for production deployments
        draft: false
        prerelease: false

    - name: Upload keystore to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./android/keystore/keystore-${{ github.event.inputs.release_tag }}.tar.gz
        asset_name: keystore-${{ github.event.inputs.release_tag }}.tar.gz
        asset_content_type: application/gzip

    - name: Clean up sensitive files
      run: |
        # Remove keystore files from workspace (they'll remain in the release)
        rm -rf android/keystore/

    - name: Output instructions
      run: |
        echo "Keystore created and published to release ${{ github.event.inputs.release_tag }}"
        echo ""
        echo "Next steps:"
        echo "1. Download the keystore from the GitHub release"
        echo "2. Extract the keystore file: tar -xzf keystore-${{ github.event.inputs.release_tag }}.tar.gz"
        echo "3. Store the keystore securely and backup the passwords:"
        echo "   - Alias: ${{ github.event.inputs.keystore_alias }}"
        echo "   - Store Password: ${{ github.event.inputs.store_password }}"
        echo "   - Key Password: ${{ github.event.inputs.key_password }}"
        echo ""
        echo "For Android builds, add these to your build.gradle or use environment variables:"
        echo "storeFile file('path/to/release.keystore')"
        echo "storePassword '${{ github.event.inputs.store_password }}'"
        echo "keyAlias '${{ github.event.inputs.keystore_alias }}'"
        echo "keyPassword '${{ github.event.inputs.key_password }}'"
