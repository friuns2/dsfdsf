name: Ensure Android Keystore Exists

on:
  workflow_dispatch: # Allow manual triggering
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  create-keystore:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow pushing to repository

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Check if keystore exists
      id: check-keystore
      run: |
        if [ -f "release.keystore" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Keystore already exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Keystore not found, will create"
        fi

    - name: Setup Java
      if: steps.check-keystore.outputs.exists == 'false'
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Create keystore
      if: steps.check-keystore.outputs.exists == 'false'
      run: |
        echo "Creating Android keystore..."
        keytool -genkeypair \
          -v \
          -keystore release.keystore \
          -alias release \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -storepass ${{ secrets.KEYSTORE_PASSWORD || 'android123' }} \
          -keypass ${{ secrets.KEYSTORE_PASSWORD || 'android123' }} \
          -dname "CN=AI Engineer Simulator, OU=Development, O=AI Engineer, L=City, ST=State, C=US"
        echo "Keystore created successfully"

    - name: Configure Git
      if: steps.check-keystore.outputs.exists == 'false'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: Commit keystore
      if: steps.check-keystore.outputs.exists == 'false'
      run: |
        git add -f release.keystore
        cat > commit_msg.txt << 'EOF'
        Add Android release keystore

        This keystore is used for signing Android APKs.
        Generated automatically by GitHub Action.

        ⚠️ IMPORTANT: Store keystore password securely!
        EOF
        git commit -F commit_msg.txt
        git push

    - name: Output result
      run: |
        if [ "${{ steps.check-keystore.outputs.exists }}" == "true" ]; then
          echo "✅ Keystore already exists - no action needed"
        else
          echo "✅ Keystore created and committed successfully"
        fi
