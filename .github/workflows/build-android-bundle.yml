name: Build Android Bundle (AAB)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-bundle:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: npm ci

      - name: Build web app
        run: npm run build

      - name: Create Capacitor config for GitHub Pages
        run: |
          # Create capacitor.config.json to use the published GitHub Pages URL
          cat > capacitor.config.json << EOF
          {
            "appId": "com.ai.engineer.simulator",
            "appName": "AI Engineer Job Simulator",
            "webDir": "dist",
            "server": {
              "url": "https://${GITHUB_ACTOR}.github.io/${GITHUB_REPOSITORY#*/}/",
              "cleartext": true
            }
          }
          EOF

      - name: Initialize Capacitor and add Android
        run: |
          npx cap init "AI Engineer Job Simulator" "com.ai.engineer.simulator" --web-dir=dist
          npx cap add android

      - name: Copy Capacitor config to Android assets
        run: |
          mkdir -p android/app/src/main/assets
          cp capacitor.config.json android/app/src/main/assets/

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Add Android permissions
        run: |
          # Add internet permission to Android manifest
          MANIFEST_FILE="android/app/src/main/AndroidManifest.xml"
          if [ -f "$MANIFEST_FILE" ]; then
            # Add internet permission if not already present
            if ! grep -q "android.permission.INTERNET" "$MANIFEST_FILE"; then
              sed -i '/<\/manifest>/i \    <uses-permission android:name="android.permission.INTERNET" />' "$MANIFEST_FILE"
            fi
            # Add network state permission
            if ! grep -q "android.permission.ACCESS_NETWORK_STATE" "$MANIFEST_FILE"; then
              sed -i '/<\/manifest>/i \    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />' "$MANIFEST_FILE"
            fi
            # Enable cleartext traffic for loading from GitHub Pages
            if ! grep -q "android:usesCleartextTraffic" "$MANIFEST_FILE"; then
              sed -i 's/<application/<application android:usesCleartextTraffic="true"/' "$MANIFEST_FILE"
            fi
          fi

      - name: Setup keystore
        run: |
          # Check if keystore exists in secrets
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "Using existing keystore from secrets"
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > release.keystore
            echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
            echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
            echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV
          else
            echo "Creating new keystore"
            # Generate a new keystore
            KEYSTORE_PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
            KEY_PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
            KEY_ALIAS="release"
            
            keytool -genkeypair -v \
              -keystore release.keystore \
              -alias $KEY_ALIAS \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storepass $KEYSTORE_PASSWORD \
              -keypass $KEY_PASSWORD \
              -dname "CN=AI Engineer Simulator, OU=Development, O=AI Engineer, L=Unknown, ST=Unknown, C=US"
            
            # Encode keystore to base64
            KEYSTORE_BASE64=$(base64 -w 0 release.keystore)
            
            echo "KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD" >> $GITHUB_ENV
            echo "KEY_ALIAS=$KEY_ALIAS" >> $GITHUB_ENV
            echo "KEY_PASSWORD=$KEY_PASSWORD" >> $GITHUB_ENV
            
            # Output the secrets for the user to add to GitHub
            echo "::warning::NEW KEYSTORE CREATED! Add these secrets to your GitHub repository:"
            echo "::warning::KEYSTORE_BASE64=$KEYSTORE_BASE64"
            echo "::warning::KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD"
            echo "::warning::KEY_ALIAS=$KEY_ALIAS"
            echo "::warning::KEY_PASSWORD=$KEY_PASSWORD"
            echo "::warning::Go to: Settings > Secrets and variables > Actions > New repository secret"
            
            # Save to file for artifact upload
            cat > keystore-info.txt << EOF
          ====================================
          IMPORTANT: Save these secrets to GitHub!
          ====================================
          
          Go to your repository Settings > Secrets and variables > Actions > New repository secret
          
          Add the following secrets:
          
          KEYSTORE_BASE64:
          $KEYSTORE_BASE64
          
          KEYSTORE_PASSWORD:
          $KEYSTORE_PASSWORD
          
          KEY_ALIAS:
          $KEY_ALIAS
          
          KEY_PASSWORD:
          $KEY_PASSWORD
          
          ====================================
          Keep these values secure and never commit them to your repository!
          ====================================
          EOF
          fi

      - name: Configure Gradle signing
        run: |
          # Create gradle.properties with signing configuration
          cat > android/gradle.properties << EOF
          android.useAndroidX=true
          android.enableJetifier=true
          RELEASE_STORE_FILE=../../release.keystore
          RELEASE_STORE_PASSWORD=$KEYSTORE_PASSWORD
          RELEASE_KEY_ALIAS=$KEY_ALIAS
          RELEASE_KEY_PASSWORD=$KEY_PASSWORD
          EOF
          
          # Update build.gradle to use signing config
          BUILD_GRADLE="android/app/build.gradle"
          if [ -f "$BUILD_GRADLE" ]; then
            # Add signing config if not already present
            if ! grep -q "signingConfigs" "$BUILD_GRADLE"; then
              # Add signing config after android {
              sed -i '/android {/a \
              \    signingConfigs {\
              \        release {\
              \            if (project.hasProperty("RELEASE_STORE_FILE")) {\
              \                storeFile file(RELEASE_STORE_FILE)\
              \                storePassword RELEASE_STORE_PASSWORD\
              \                keyAlias RELEASE_KEY_ALIAS\
              \                keyPassword RELEASE_KEY_PASSWORD\
              \            }\
              \        }\
              \    }' "$BUILD_GRADLE"
            fi
            
            # Update release buildType to use signingConfig
            if grep -q "buildTypes" "$BUILD_GRADLE"; then
              sed -i '/release {/a \            signingConfig signingConfigs.release' "$BUILD_GRADLE"
            fi
          fi

      - name: Build Android Bundle (AAB)
        run: |
          cd android
          chmod +x gradlew
          ./gradlew bundleRelease

      - name: Build Debug APK (for testing)
        run: |
          cd android
          ./gradlew assembleDebug

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Get version code
        id: version
        run: |
          VERSION_CODE=$(date +'%Y%m%d%H')
          echo "code=$VERSION_CODE" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.date.outputs.date }}
          name: Release ${{ steps.date.outputs.date }}
          body: |
            Automated Android build from commit ${{ github.sha }}
            
            **Version Code:** ${{ steps.version.outputs.code }}

            **Files:**
            - `app-release.aab` - Signed bundle for Google Play Store
            - `app-debug.apk` - Debug APK for testing
            
            **Changes:**
            ${{ github.event.head_commit.message }}
            
            ---
            
            **For Google Play Console:**
            1. Go to Google Play Console > Your App > Production/Testing
            2. Click "Create new release"
            3. Upload the `app-release.aab` file
            4. Fill in release notes and submit for review
          draft: false
          prerelease: false
          files: |
            android/app/build/outputs/bundle/release/app-release.aab
            android/app/build/outputs/apk/debug/app-debug.apk
            keystore-info.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
